#cloud-config
# INFERA WebNova - k3s Worker Node Cloud-Init

package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - apt-transport-https
  - ca-certificates
  - ufw
  - fail2ban
  - unattended-upgrades
  - jq
  - htop

write_files:
  - path: /etc/sysctl.d/99-kubernetes.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
      fs.inotify.max_user_watches = 524288
      fs.inotify.max_user_instances = 512
    permissions: '0644'

  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
    permissions: '0644'

  - path: /root/setup-k3s-worker.sh
    content: |
      #!/bin/bash
      set -e
      
      echo "Setting up k3s worker node: ${node_name}"
      
      # Apply sysctl settings
      sysctl --system
      
      # Configure firewall
      ufw default deny incoming
      ufw default allow outgoing
      ufw allow ssh
      ufw allow 10250/tcp # kubelet
      ufw allow 8472/udp  # flannel
      ufw allow 51820/udp # wireguard
      ufw allow 51821/udp # wireguard
      ufw allow 80/tcp    # http
      ufw allow 443/tcp   # https
      ufw allow 30000:32767/tcp # NodePort range
      ufw --force enable
      
      # Start fail2ban
      systemctl enable fail2ban
      systemctl start fail2ban
      
      echo "Worker node ${node_name} prepared - will join cluster via Ansible"
      echo "Master IP for joining: ${master_ip}"
    permissions: '0755'

runcmd:
  - /root/setup-k3s-worker.sh

final_message: "INFERA WebNova k3s worker ${node_name} ready in $UPTIME seconds"
